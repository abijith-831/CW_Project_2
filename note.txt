


import React, { useState, useRef, useEffect } from 'react';
import { useSnackbar } from "notistack";
import { useDispatch, useSelector } from 'react-redux';
import { updateSelectedColumns } from '../../redux/slices/authSlice';
import { useTranslation } from 'react-i18next';

interface Tag {
  topic: string;
  count: number;
  color?: string;
}

const XIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-3 w-3">
    <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
  </svg>
);

const TagIcon = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="h-3 w-3">
    <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/>
    <path d="M7 7h.01"/>
  </svg>
);

interface TagMultiSelectProps {
  columnVisibility : Record<string , boolean>
  setColumnVisibility : (state : Record<string , boolean>) => void
}

const TagMultiSelect: React.FC<TagMultiSelectProps> = ({ columnVisibility , setColumnVisibility }) => {
  const { t } = useTranslation();
  const [isOpen, setIsOpen] = useState(false);
  const [selectedTags, setSelectedTags] = useState<Tag[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [allTags, setAllTags] = useState<Tag[]>([]);

  const wrapperRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);
  const { enqueueSnackbar } = useSnackbar();
  const dispatch = useDispatch();
  const selectedColumnNames = useSelector((state: any) => state.auth.currentUser?.selected_columns);

  console.log('Selected column names from Redux:', selectedColumnNames);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Initialize all available tags/columns
  useEffect(() => {
    const columns = table
      ?.getAllColumns()
      ?.filter((col: any) => col.getCanHide())
      .map((col: any) => ({
        topic: typeof col.columnDef.header === "string" ? col.columnDef.header : col.id,
        count: 0,
      }));

    setAllTags(columns || []);
  }, [table]);

  // SINGLE CONSOLIDATED EFFECT - Sync selectedTags and table visibility with Redux
  useEffect(() => {
    if (!selectedColumnNames || selectedColumnNames.length === 0 || !table) return;

    console.log('Syncing with Redux selectedColumnNames:', selectedColumnNames);

    // Get all available columns from table
    const columns = table
      .getAllColumns()
      .filter((col: any) => col.getCanHide())
      .map((col: any) => ({
        topic: typeof col.columnDef.header === "string" ? col.columnDef.header : col.id,
        count: 0,
      }));

    console.log('All available columns:', columns);

    // Filter to only show columns that are in selectedColumnNames
    const columnsToShow = columns.filter((col: Tag) =>
      selectedColumnNames.includes(col.topic)
    );

    console.log('Columns to show (selectedTags):', columnsToShow);

    // Update selectedTags state
    setSelectedTags(columnsToShow);

    // Update table column visibility to match Redux
    table.getAllColumns().forEach((col: any) => {
      const colName = typeof col.columnDef.header === "string"
        ? col.columnDef.header
        : col.id;

      if (col.getCanHide()) {
        const shouldBeVisible = selectedColumnNames.includes(colName);
        const isCurrentlyVisible = col.getIsVisible();

        // Only toggle if state doesn't match
        if (isCurrentlyVisible !== shouldBeVisible) {
          console.log(`Toggling ${colName}: ${isCurrentlyVisible} -> ${shouldBeVisible}`);
          col.toggleVisibility();
        }
      }
    });
  }, [selectedColumnNames, table]);

  console.log('Current selectedTags state:', selectedTags);

  // Toggle column visibility
  const toggleTag = (tag: Tag) => {
    const isSelected = selectedTags.some(t => t.topic === tag.topic);

    if (isSelected && selectedTags.length <= 1) {
      enqueueSnackbar("Keep at least one column in table", { variant: "error" });
      return;
    }

    const col = table.getAllColumns().find(
      (c: any) =>
        (typeof c.columnDef.header === "string" ? c.columnDef.header : c.id) === tag.topic
    );

    if (col) {
      col.toggleVisibility();

      setSelectedTags(prev => {
        const updated = prev.some(t => t.topic === tag.topic)
          ? prev.filter(t => t.topic !== tag.topic)
          : [...prev, tag];

        console.log('Updated tags after toggle:', updated);

        // Update Redux
        dispatch(updateSelectedColumns(updated.map(t => t.topic)));

        return updated;
      });
    }

    setSearchTerm('');
    inputRef.current?.focus();
  };

  // Remove a tag/column
  const removeTag = (tag: Tag) => {
    if (selectedTags.length <= 1) {
      enqueueSnackbar("Keep at least one column in table", { variant: "error" });
      return;
    }

    const col = table.getAllColumns().find(
      (c: any) =>
        (typeof c.columnDef.header === "string" ? c.columnDef.header : c.id) === tag.topic
    );

    if (col) {
      col.toggleVisibility();

      const updatedTags = selectedTags.filter(t => t.topic !== tag.topic);
      setSelectedTags(updatedTags);

      // Update Redux
      dispatch(updateSelectedColumns(updatedTags.map(t => t.topic)));
    }
  };

  const filteredTags = allTags.filter(tag =>
    !selectedTags.some(t => t.topic === tag.topic) &&
    tag.topic.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="w-full max-w-xl" ref={wrapperRef}>
      <div className="relative">
        <div
          className="flex flex-wrap items-center gap-2 p-2 min-h-[40px] text-sm border border-slate-300 dark:border-neutral-500 bg-white dark:bg-neutral-600 rounded-md cursor-text shadow-sm focus-within:ring-2"
          onClick={() => {
            setIsOpen(true);
            inputRef.current?.focus();
          }}
        >
          {/* Show only first 3 selected tags */}
          {selectedTags.slice(0, 3).map(tag => (
            <div
              key={tag.topic}
              className="flex items-center gap-1.5 bg-[#97bdbd] dark:bg-bg-primary cursor-pointer font-medium px-2 py-1 rounded-full text-xs"
            >
              <TagIcon />
              {tag.topic}
              <button
                type="button"
                disabled={selectedTags.length <= 1}
                className={`cursor-pointer hover:bg-green-700 rounded-full ${
                  selectedTags.length <= 1 ? "opacity-40 cursor-not-allowed" : ""
                }`}
                onClick={e => {
                  e.stopPropagation();
                  if (selectedTags.length > 1) removeTag(tag);
                }}
              >
                <XIcon />
              </button>
            </div>
          ))}

          {/* If more than 3 ‚Üí show text */}
          {selectedTags.length > 3 && (
            <span className="text-xs ml-1 text-secondary dark:text-table-header">
              +{selectedTags.length - 3} {t("more")}
            </span>
          )}

          {selectedTags.length <= 3 && (
            <input
              ref={inputRef}
              type="text"
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              onFocus={() => setIsOpen(true)}
              placeholder={selectedTags.length === 0 ? t("select_columns") : ""}
              className="flex-1 bg-transparent outline-none text-sm min-w-[60px]"
            />
          )}
        </div>

        {isOpen && (
          <div className="absolute z-10 w-full mt-2 max-h-60 overflow-y-auto bg-white dark:bg-neutral-700 dark:border-neutral-500 border rounded-md shadow-lg">
            <ul className="p-1 space-y-1">
              {allTags.length > 0 ? (
                allTags
                  .filter(tag =>
                    tag.topic.toLowerCase().includes(searchTerm.toLowerCase())
                  )
                  .map((tag) => {
                    const checked = selectedTags.some(t => t.topic === tag.topic);
                    return (
                      <li
                        key={tag.topic}
                        className="flex items-center gap-2 p-2 rounded-md hover:bg-gray-50 dark:hover:bg-neutral-600"
                      >
                        <input
                          type="checkbox"
                          checked={checked}
                          onChange={() => {
                            if (checked) {
                              removeTag(tag);
                            } else {
                              toggleTag(tag);
                            }
                          }}
                          className="cursor-pointer"
                        />
                        <label
                          className="flex-1 cursor-pointer dark:text-neutral-300"
                          onClick={() => {
                            if (checked) removeTag(tag);
                            else toggleTag(tag);
                          }}
                        >
                          {tag.topic}
                        </label>
                      </li>
                    );
                  })
              ) : (
                <li className="p-2 text-center text-gray-500 dark:text-neutral-400">No columns found.</li>
              )}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
};

export default function TagMultiSelectPage({ table }: { table: any }) {
  return (
    <div className="text-sm">
      <div className="w-full max-w-2xl">
        <TagMultiSelect table={table} />
      </div>
    </div>
  );
}









{loading ? (
        <div className="table-row-group text-sm">
          {table.getRowModel().rows.map(row => (
            <div onClick={()=>onCompanyClick?.(row.original)} className="table-row hover:bg-gray-50 dark:hover:bg-neutral-700 cursor-pointer" key={row.id}>
              {row.getVisibleCells().map(cell => (
                <div className="table-cell dark:text-neutral-400 px-4 py-2.5 border-r  border-border-primary dark:border-neutral-600 last:border-r-0 border-b border-border-secondary relative overflow-visible">
                  {/* {loading ? (<TableSkeleton/>) : (flexRender(cell.column.columnDef.cell, cell.getContext()))}               */}
                  <TableSkeleton/>
                </div>
              ))}
            </div>
          ))}
          </div>
       ) : (
          <div className="table-row-group text-sm">
            {table.getRowModel().rows.map(row => (
              <div onClick={()=>onCompanyClick?.(row.original)} className="table-row hover:bg-gray-50 dark:hover:bg-neutral-700 cursor-pointer" key={row.id}>
                {row.getVisibleCells().map(cell => (
                  <div className="table-cell dark:text-neutral-400 px-4 py-2.5 border-r  border-border-primary dark:border-neutral-600 last:border-r-0 border-b border-border-secondary relative overflow-visible">
                    {/* {loading ? (<TableSkeleton/>) : (flexRender(cell.column.columnDef.cell, cell.getContext()))}               */}
                    {(flexRender(cell.column.columnDef.cell, cell.getContext()))}
                  </div>
                ))}
              </div>
            ))}
          </div>
        )}








        <div className="table-row-group text-sm">
            {table.getRowModel().rows.map(row => (
              <div onClick={()=>onCompanyClick?.(row.original)} className="table-row hover:bg-gray-50 dark:hover:bg-neutral-700 cursor-pointer" key={row.id}>
                {row.getVisibleCells().map(cell => (
                  <div className="table-cell dark:text-neutral-400 px-4 py-2.5 border-r  border-border-primary dark:border-neutral-600 last:border-r-0 border-b border-border-secondary relative overflow-visible">
                    {loading ? (<TableSkeleton/>) : (flexRender(cell.column.columnDef.cell, cell.getContext()))}              
                    {/* {(flexRender(cell.column.columnDef.cell, cell.getContext()))} */}
                  </div>
                ))}
              </div>
            ))}
          </div>
















































{item.question === "Registration Details" && (
            <>
              <div className="flex items-center justify-between text-xs md:text-sm px-6 ">
                <div className=" w-1/2">
                      <p className="flex">
                      <strong className="">Authorised Capital</strong>
                      <span className="px-4">-</span>
                      <span className="flex-1">{company.AuthorizedCapital}</span></p>
                   </div>
                   <div className=" w-1/2">
                      <p className="flex">
                      <strong className="">Paid up Capital</strong>
                      <span className="px-4">-</span>
                      <span className="flex-1">{company.PaidupCapital}</span></p>
                   </div>
              </div>
                <p className="flex text-xs md:text-sm px-6">
                    <strong className="">Registration Address</strong>
                    <span className="px-4">-</span>
                    <span className="flex-1">{company.PaidupCapital}</span>
                </p>
             </>
          )}


          Registration Date - 2013-11-13

State Code - delhi

Registered Address
- F - 201, Ashish Complex, 2 Local Shopping Centre, New Rajdhani Enclave, Vikas Marg, Delhi,-110092,Delhi,East Delhi,Delhi,110092-India


Industrial Classification - Real Estate and Renting

NIC Code - 70109

Indian/Foreign
-Indian

 <div className="flex items-center justify-between text-xs md:text-sm px-8 ">
                <p><strong>Industrial Classification</strong> - {company.CompanyIndustrialClassification}</p>
                <p><strong>NIC Code</strong> - {company.nic_code}</p>
              </div>
              <p className="flex items-center justify-between text-xs md:text-sm px-8 "><strong>Indian/Foreign</strong> -Indian</p>












































Your current function does not support filters or limit

So let‚Äôs fix it.

‚úÖ Revised getCompanyData (supports selectedState)

src/api/companyData.api.ts

import axios from "axios";

const API_URL = import.meta.env.VITE_API_URL;

export const getCompanyData = async (selectedState?: string) => {
  try {
    let url = `${API_URL}&limit=50`;

    if (selectedState) {
      url += `&filters%5BCompanyStateCode%5D=${selectedState}`;
    }

    const response = await axios.get(url);
    return response.data;
  } catch (error) {
    console.log("API error:", error);
    throw error;
  }
};


‚úî Supports filters
‚úî Supports limit
‚úî Works with axios
‚úî Reusable anywhere

‚úÖ 2. Update useEffect inside Dashboard

Replace your entire useEffect with:

useEffect(() => {
  const fetchData = async () => {
    try {
      setLoading(true);

      const result = await getCompanyData(selectedState);
      setCompanyData(result.records || []);
      setCurrentPage(1);

    } catch (error) {
      console.log(error);
    } finally {
      setTimeout(() => {
        setLoading(false);
      }, 2000);
    }
  };

  fetchData();
}, [selectedState]);

üéâ Now What Happens
When selectedState changes:

‚úî Call API using axios
‚úî API includes filter query
‚úî Data updates
‚úî Pagination resets
‚úî Loading state shows for 2 seconds             




















**TableView should NOT handle items_per_page itself.

Dashboard must own the state, and TableView should only notify when it changes.**

‚úÖ 1Ô∏è‚É£ Modify TableView Props

Add a new prop:

interface TableViewProps {
  companyData?: CompanyDataProps[];
  loading?: boolean;
  onCompanyClick?: (company: CompanyDataProps) => void;
  onItemsPerPageChange?: (value: 10 | 15 | 20) => void; // NEW
}

‚úÖ 2Ô∏è‚É£ Remove DB calls & Redux calls from TableView (Dashboard will handle them)

Replace your entire handleItemsPerPage() with this:

const handleItemsPerPage = (value: 10 | 15 | 20) => {
  onItemsPerPageChange?.(value); // call parent function
};


That's it. TableView no longer updates Redux or DB.

‚úÖ 3Ô∏è‚É£ Use Dashboard to update Redux + DB + local state

In Dashboard, add:

const handleItemsPerPageChange = async (value: 10 | 15 | 20) => {
  setItemsPerPage(value);                   // Update Dashboard UI state
  dispatch(updateItemsPerPage(value));      // Redux update

  if (user?.id) {
    await updateItemsPerPageInDB(user.id, value); // DB update
  }

  setCurrentPage(1); // Reset pagination
};

‚úÖ 4Ô∏è‚É£ Pass the callback to TableView
<TableView
    companyData={currentItems}
    loading={loading}
    onCompanyClick={onSelectCompany}
    onItemsPerPageChange={handleItemsPerPageChange}  // NEW
/>

‚úÖ 5Ô∏è‚É£ Fix TableView Select Dropdown

Modify your select:

<select
  value={items_per_page}
  onChange={(e) => handleItemsPerPage(Number(e.target.value) as 10 | 15 | 20)}
  className="border text-sm py-2.5 px-8 border-slate-300 dark:border-border-dark-primary text-secondary dark:text-table-header shadow rounded-md"
>
  <option value={10}>10 Items</option>
  <option value={15}>15 Items</option>
  <option value={20}>20 Items</option>
</select>

üéâ Final Result

TableView only triggers the change

Dashboard owns & manages the real state

Redux + DB + Pagination all stay in sync

No more TypeScript errors

Clean architecture